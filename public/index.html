<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Boss Attendance — Live update</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#061018;
      --panel:#0e1720;
      --muted:#93a3af;
      --accent:#22d3a6;
      --card-border: rgba(255,255,255,0.04);
      --text:#e6eef6;
      --danger:#ff6b6b;
      --glass: rgba(255,255,255,0.02);
    }
    *{box-sizing:border-box;font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system; color:var(--text)}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#041018 0%, #07121a 100%);padding:18px}
    .wrap{max-width:1400px;margin:0 auto;border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:10px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    header h1{margin:0;font-size:20px}
    header .subtitle{color:var(--muted);font-size:13px}

    /* main layout: left narrow, center wide, right narrow */
    .main{display:grid;grid-template-columns:320px 1fr 340px;gap:14px}
    .panel{background:var(--panel);border-radius:10px;padding:12px;border:1px solid var(--card-border);box-shadow:0 8px 24px rgba(0,0,0,0.5)}
    .panel h2{margin:0 0 8px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .form-row{display:flex;gap:8px;margin-bottom:8px}
    input[type="text"], input[type="datetime-local"], select {width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#07121a;color:var(--text)}
    button{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#052a25;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
    button.small{padding:6px 8px;font-size:13px}
    .boss-list{margin-top:8px;max-height:520px;overflow:auto;padding-right:6px}
    .boss-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .boss-item .left{max-width:70%}
    .boss-item .title{font-weight:600}
    .boss-item .meta{font-size:12px;color:var(--muted)}
    .boss-actions{display:flex;gap:8px;align-items:center}

    /* center area: top: active card + upload, below: big 3-column table */
    .active-card{background:var(--glass);padding:12px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
    .active-left{display:flex;flex-direction:column;gap:6px}
    .active-left .row{display:flex;gap:10px;align-items:center}
    .big-grid{display:grid;grid-template-columns:240px 1fr 220px;gap:10px}
    .list{background:transparent;padding:8px;border-radius:8px;max-height:440px;overflow:auto}
    .list .row{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .voice-name{font-weight:600}
    .upload-preview{display:flex;flex-direction:column;gap:8px}
    .upload-preview img{max-width:100%;border-radius:6px;border:1px solid rgba(255,255,255,0.03)}
    .footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

    .update-wrapper{display:flex;justify-content:center;margin-top:10px}
    .update-to-discord{background:linear-gradient(90deg,var(--accent),#06b6a4);padding:10px 16px;border-radius:10px;border:0;color:#052a25;font-weight:700;cursor:pointer}

    /* tiny helpers */
    .kbd{background:rgba(255,255,255,0.03);padding:4px 8px;border-radius:6px;font-size:12px;color:var(--muted)}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted)}
    .matched{color:var(--accent);font-weight:700}

    /* responsive */
    @media (max-width:1100px){
      .main{grid-template-columns:1fr; }
      .big-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Boss Attendance — Live update</h1>
        <div class="subtitle">Realtime • Discord voice detection • OCR image upload • Dark theme</div>
      </div>
      <div class="muted">Status: <span id="status">connecting…</span></div>
    </header>

    <div class="main">
      <!-- LEFT: Spawning Boss -->
      <section class="panel" id="leftPanel">
        <h2>Spawning Boss</h2>

        <div style="margin-bottom:8px">
          <input id="bossName" type="text" placeholder="boss name" />
        </div>
        <div style="margin-bottom:8px">
          <input id="bossDate" type="datetime-local" />
        </div>
        <div class="form-row">
          <button id="addBoss">Add boss</button>
          <button id="clearFields" class="ghost small">Clear</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <div class="kbd">boss list</div>
          <div class="muted">click a boss → set active</div>
        </div>

        <div class="boss-list" id="bossList" aria-live="polite">
          <!-- boss items inserted here -->
        </div>
      </section>

      <!-- CENTER: Active / Voice / Attendance -->
      <section class="panel" id="centerPanel">
        <h2>Active Boss — Attendance</h2>

        <!-- Active card + upload -->
        <div class="active-card">
          <div class="active-left">
            <div><strong>Active:</strong> <span id="activeName">—</span></div>
            <div class="row"><div><strong>Spawn:</strong> <span id="activeSpawn">—</span></div>
              <div style="margin-left:12px" class="muted">Remaining: <span id="activeRemaining">—</span></div>
            </div>
            <div class="row" style="margin-top:6px;">
              <button id="setActiveFirst" class="small ghost">Set first boss active</button>
              <button id="clearActive" class="small ghost">Clear active</button>
            </div>
          </div>

          <div style="width:360px;display:flex;flex-direction:column;gap:8px;align-items:flex-end">
            <div style="width:100%">
              <label class="muted" style="font-size:12px">Upload image for attendance detection</label>
              <div style="display:flex;gap:8px;margin-top:6px">
                <input id="imageInput" type="file" accept="image/*" style="flex:1" />
                <button id="uploadBtn" class="small">Upload</button>
              </div>
            </div>
            <div class="muted" style="font-size:12px">Date today used for attendance</div>
          </div>
        </div>

        <!-- Big grid: Voice | Attendance List | Upload Detected -->
        <div class="big-grid" style="margin-top:10px">
          <!-- Discord Voice-Chat live -->
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="muted">Discord Voice-Chat — live</div>
              <div class="tag" id="vcCount">0</div>
            </div>
            <div class="list" id="voiceList" aria-live="polite">
              <!-- voice members -->
            </div>
          </div>

          <!-- Attendance list (center) -->
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="muted">Attendance — active VC + boss name + date</div>
              <div class="muted" id="attendanceTime">—</div>
            </div>
            <div class="list" id="attendanceList" aria-live="polite">
              <!-- matched attendance rows -->
            </div>
            <div class="update-wrapper">
              <button id="updateDiscord" class="update-to-discord">Update to Discord</button>
            </div>
          </div>

          <!-- Upload image list / detected names -->
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="muted">Image upload list / detected</div>
              <div class="muted">Detect same in Discord</div>
            </div>
            <div class="list" id="uploadList" aria-live="polite">
              <!-- uploads -->
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Additional controls / previews -->
      <section class="panel" id="rightPanel">
        <h2>Preview & Controls</h2>
        <div style="margin-bottom:8px">
          <div class="muted">Latest upload preview</div>
          <div class="upload-preview" id="previewBox" style="margin-top:8px">
            <!-- preview image inserted -->
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Admin</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <button id="testWebhook" class="ghost small">Test webhook (server)</button>
            <button id="downloadData" class="ghost small">Download data.json</button>
            <button id="clearRecords" class="ghost small" style="color:var(--danger)">Clear upload records</button>
          </div>
        </div>

        <div style="margin-top:12px" class="muted">Notes: after Update to Discord, active boss will be cleared (attendance saved).</div>
      </section>
    </div>

    <div class="footer">
      <small>Server must run with Discord token, VOICE_CHANNEL_ID, and webhook configured. Realtime via Socket.IO.</small>
    </div>
  </div>

  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const state = { data: null, voice: [], uploads: [] };

    // helpers
    const $ = id => document.getElementById(id);
    const fmt = t => t ? new Date(t).toLocaleString() : '—';
    const pad = n => n.toString().padStart(2,'0');

    // render functions
    function renderBossList(bosses){
      const list = $('bossList'); list.innerHTML = '';
      bosses.forEach(b => {
        const div = document.createElement('div');
        div.className = 'boss-item';
        div.innerHTML = `
          <div class="left">
            <div class="title">${escapeHtml(b.name)}</div>
            <div class="meta">${fmt(b.spawnDateISO)}</div>
          </div>
          <div class="boss-actions">
            <button class="small" data-id="${b.id}" data-action="set">Set active</button>
            <button class="small ghost" data-id="${b.id}" data-action="del">Delete</button>
          </div>`;
        list.appendChild(div);
      });

      // bind
      list.querySelectorAll('button[data-action]').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          const act = btn.dataset.action;
          if(act === 'set'){
            const boss = state.data.bosses.find(x=>x.id===id);
            socket.emit('set_active', boss);
          } else if(act === 'del'){
            if(confirm('Delete boss?')) fetch('/api/bosses/' + id, { method:'DELETE' });
          }
        };
      });
    }

    function renderActive(active){
      $('activeName').textContent = active?.name || '—';
      $('activeSpawn').textContent = active?.spawnDateISO ? fmt(active.spawnDateISO) : '—';
      $('activeRemaining').textContent = active?.spawnDateISO ? remainingText(active.spawnDateISO) : '—';
    }

    function remainingText(iso){
      const diff = Math.max(0, new Date(iso) - Date.now());
      const s = Math.floor(diff/1000);
      const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60); const sec = s%60;
      return (h? h+'h ':'') + (m? m+'m ':'') + sec+'s';
    }

    function renderVoice(voice){
      state.voice = voice || [];
      $('voiceList').innerHTML = '';
      $('vcCount').textContent = (state.voice.length || 0);
      state.voice.forEach(v => {
        const row = document.createElement('div');
        row.className = 'row';
        const name = v.displayName || v.username || 'unknown';
        const dur = Math.floor((Date.now() - (v.joinedAt||Date.now()))/1000);
        const m = Math.floor(dur/60), s = dur%60;
        row.innerHTML = `<div><div class="voice-name">${escapeHtml(name)}</div><div class="muted">${m}m ${s}s in voice</div></div>`;
        $('voiceList').appendChild(row);
      });
      updateAttendanceList();
    }

    function renderUploads(records){
      state.uploads = records || [];
      const ul = $('uploadList'); ul.innerHTML = '';
      (state.uploads||[]).slice(0,20).forEach(r => {
        const row = document.createElement('div');
        row.className = 'row';
        const detected = (r.detected && r.detected.length) ? r.detected.join(', ') : '<em>No text detected</em>';
        row.innerHTML = `<div><div><strong>${new Date(r.uploadedAt).toLocaleString()}</strong></div><div class="muted">${escapeHtml(detected)}</div></div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <a class="small ghost" href="/uploads/${r.file}" target="_blank">preview</a>
          </div>`;
        ul.appendChild(row);
      });

      // preview latest
      const prev = $('previewBox'); prev.innerHTML = '';
      if(state.uploads[0]){
        const img = document.createElement('img');
        img.src = '/uploads/' + state.uploads[0].file;
        prev.appendChild(img);
      }
    }

    function updateAttendanceList(){
      // Use latest upload to match names with voice members
      const last = state.uploads[0] || { detected: [] };
      const detected = (last.detected || []).map(d => normalize(d)).filter(Boolean);
      $('attendanceList').innerHTML = '';
      (state.voice || []).forEach(v => {
        const name = (v.displayName || v.username || '').trim();
        const nrm = normalize(name);
        const dur = Math.floor((Date.now() - (v.joinedAt||Date.now()))/1000);
        const mins = Math.floor(dur/60), s = dur%60;
        // find matches
        const matches = detected.filter(d => matchName(d, nrm));
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `<div><div><strong>${escapeHtml(name)}</strong> ${matches.length ? '<span class="matched">• matched</span>' : ''}</div>
                         <div class="muted">Duration: ${mins}m ${s}s ${matches.length ? ' • ' + escapeHtml(matches.join(', ')) : ''}</div></div>`;
        $('attendanceList').appendChild(row);
      });
      $('attendanceTime').textContent = new Date().toLocaleString();
    }

    // normalization & matching
    function normalize(s){ return (s||'').toLowerCase().replace(/[^0-9a-z]/gi,'').trim(); }
    function matchName(a,b){
      if(!a || !b) return false;
      return b.includes(a) || a.includes(b) || b.startsWith(a) || a.startsWith(b);
    }

    // escape
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

    // DOM bindings
    $('addBoss').onclick = async () => {
      const name = $('bossName').value.trim();
      const dateVal = $('bossDate').value;
      if(!name || !dateVal) return alert('Enter boss name and spawn datetime');
      const spawnDateISO = new Date(dateVal).toISOString();
      await fetch('/api/bosses', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, spawnDateISO })});
      $('bossName').value=''; $('bossDate').value='';
    };

    $('clearFields').onclick = ()=>{ $('bossName').value=''; $('bossDate').value=''; };
    $('setActiveFirst').onclick = ()=> {
      if(!state.data || !state.data.bosses || !state.data.bosses.length) return alert('No boss available');
      socket.emit('set_active', state.data.bosses[0]);
    };
    $('clearActive').onclick = ()=> {
      socket.emit('set_active', null);
    };

    $('uploadBtn').onclick = async ()=> {
      const f = $('imageInput').files[0];
      if(!f) return alert('Choose an image first');
      const fd = new FormData(); fd.append('image', f);
      $('uploadBtn').disabled = true;
      try {
        const res = await fetch('/api/upload', { method:'POST', body: fd });
        const j = await res.json();
        if(!j.ok) alert('Upload failed: ' + (j.err || 'unknown'));
        else alert('Upload OK — detected: ' + (j.detected.join(', ') || 'none'));
      } catch(e){ alert('Upload error: ' + e.message); }
      $('uploadBtn').disabled = false;
    };

    $('updateDiscord').onclick = ()=> {
      const active = state.data?.activeBoss;
      if(!active) return alert('No active boss set');
      const attendance = (state.voice||[]).map(v => {
        return {
          username: v.displayName || v.username || 'unknown',
          durationSec: Math.floor((Date.now() - (v.joinedAt||Date.now()))/1000),
          matchedNames: []
        };
      });
      // match with latest upload
      const last = state.uploads[0];
      if(last){
        attendance.forEach(a => {
          const aNorm = normalize(a.username);
          a.matchedNames = (last.detected||[]).filter(n => matchName(normalize(n), aNorm));
        });
      }
      socket.emit('update_to_discord', { activeBoss: active, attendance });
    };

    // admin buttons
    $('testWebhook').onclick = ()=> {
      fetch('/api/test-webhook', { method:'POST' }).then(r=>r.json()).then(j => alert(JSON.stringify(j))).catch(e=>alert('error: '+e.message));
    };
    $('downloadData').onclick = ()=> { window.open('/data.json','_blank'); };
    $('clearRecords').onclick = ()=> {
      if(!confirm('Clear upload records?')) return;
      fetch('/api/clear-uploads', { method:'POST' }).then(()=> alert('Cleared')).catch(e=>alert('error'));
    };

    // socket listeners
    socket.on('connect', () => { $('status').textContent = 'connected'; });
    socket.on('disconnect', () => { $('status').textContent = 'disconnected'; });

    socket.on('init', payload => {
      state.data = payload.data || {};
      state.voice = payload.voice || [];
      renderAll();
    });

    socket.on('data_update', d => {
      state.data = d;
      renderAll();
    });

    socket.on('voice_update', voice => {
      // server provides joinedAt timestamps
      state.voice = voice.map(v => ({ ...v }));
      renderVoice(state.voice);
    });

    socket.on('upload_done', rec => {
      // add to local state
      state.data.attendanceRecords = state.data.attendanceRecords || [];
      state.data.attendanceRecords.unshift(rec);
      renderUploads(state.data.attendanceRecords);
      updateAttendanceList();
    });

    socket.on('discord_ok', msg => { alert('Discord: ' + msg); });
    socket.on('discord_error', msg => { alert('Discord error: ' + msg); });

    // render everything
    function renderAll(){
      renderBossList(state.data.bosses || []);
      renderActive(state.data.activeBoss);
      renderVoice(state.voice || []);
      renderUploads(state.data.attendanceRecords || []);
      updateAttendanceList();
    }

    // keep remaining time live
    setInterval(()=> {
      if(state.data && state.data.activeBoss) renderActive(state.data.activeBoss);
    }, 1000);
  </script>
</body>
</html>
